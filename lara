äº†è§£ã—ã¾ã—ãŸï¼
ã§ã¯ã€Laravel å´ã¯ JSONãƒ­ã‚°ã« request_id ã‚„ log_type ã‚’ extra ã«ä¿æŒã™ã‚‹å½¢ã®ã¾ã¾ã€CloudWatch Logs Insights å´ã§ json() é–¢æ•°ã‚’ä½¿ã£ã¦å€¤ã‚’å–ã‚Šå‡ºã™æ§‹æˆã§é€²ã‚ã¾ã—ã‚‡ã†ã€‚

â¸»

âœ… æ–¹é‡ï¼šextra.log_type / extra.request_id ã‚’ä¿æŒã—ãŸã¾ã¾ä½¿ã†

é …ç›®	å†…å®¹
Laravelãƒãƒ¼ã‚¸ãƒ§ãƒ³	Laravel 12
ãƒ­ã‚°å‡ºåŠ›å…ˆ	php://stdout / php://stderrï¼ˆFargateç­‰ã§CloudWatchã¸è»¢é€ï¼‰
ãƒ­ã‚°å½¢å¼	JSONå½¢å¼ï¼ˆMonolog JsonFormatterï¼‰
è¿½åŠ é …ç›®	request_id, log_type â†’ extra ã«è¿½åŠ 
CloudWatchå¯¾å¿œ	Logs Insights ã® json() é–¢æ•°ã§æŠ½å‡ºã—ã¦æ¤œç´¢å¯èƒ½


â¸»

âœ… å®Ÿè£…å†…å®¹

â¸»

âœ… â‘  ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ç™ºè¡Œ

ğŸ“ app/Http/Middleware/RequestIdMiddleware.php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Support\Str;

class RequestIdMiddleware
{
    public function handle($request, Closure $next)
    {
        $requestId = $request->header('X-Request-ID') ?? (string) Str::uuid();
        app()->instance('request_id', $requestId);

        $response = $next($request);
        $response->headers->set('X-Request-ID', $requestId);

        return $response;
    }
}

ğŸ“Œ ç™»éŒ²ï¼šapp/Http/Kernel.php

protected $middleware = [
    \App\Http\Middleware\RequestIdMiddleware::class,
];


â¸»

âœ… â‘¡ Processorï¼šextra ã«è¿½åŠ 

ğŸ“ app/Logging/AddRequestIdAndTypeProcessor.php

namespace App\Logging;

class AddRequestIdAndTypeProcessor
{
    public function __invoke(array $record)
    {
        $record['extra']['request_id'] = app()->bound('request_id') ? app('request_id') : null;
        $record['extra']['log_type'] = $this->determineLogType($record);
        return $record;
    }

    protected function determineLogType(array $record): string
    {
        if ($record['level'] >= 400 || isset($record['context']['exception'])) {
            return 'system';
        }
        return 'operation';
    }
}


â¸»

âœ… â‘¢ ãƒ­ã‚°ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®šï¼ˆconfig/logging.phpï¼‰

âœ… stdout_jsonï¼ˆæ“ä½œãƒ­ã‚°ãªã©ï¼‰

'stdout_json' => [
    'driver' => 'monolog',
    'handler' => Monolog\Handler\StreamHandler::class,
    'with' => ['stream' => 'php://stdout'],
    'formatter' => Monolog\Formatter\JsonFormatter::class,
    'formatter_with' => ['include_stacktraces' => false],
    'processors' => [App\Logging\AddRequestIdAndTypeProcessor::class],
],

âœ… stderr_jsonï¼ˆã‚¨ãƒ©ãƒ¼ãƒ»ä¾‹å¤–ï¼‰

'stderr_json' => [
    'driver' => 'monolog',
    'handler' => Monolog\Handler\StreamHandler::class,
    'with' => ['stream' => 'php://stderr'],
    'formatter' => Monolog\Formatter\JsonFormatter::class,
    'formatter_with' => ['include_stacktraces' => true],
    'processors' => [App\Logging\AddRequestIdAndTypeProcessor::class],
],


â¸»

âœ… â‘£ ãƒ­ã‚°å‡ºåŠ›ä¾‹

// æ“ä½œãƒ­ã‚°
Log::channel('stdout_json')->info('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ“ä½œã‚’å®Ÿè¡Œ', [
    'user_id' => Auth::id(),
]);

// ã‚¨ãƒ©ãƒ¼
try {
    throw new \RuntimeException('å†…éƒ¨ã‚¨ãƒ©ãƒ¼');
} catch (\Throwable $e) {
    Log::channel('stderr_json')->error('ä¾‹å¤–ç™ºç”Ÿ', ['exception' => $e]);
}


â¸»

âœ… CloudWatch Logs Insights ã‚¯ã‚¨ãƒªä¾‹

ğŸ” log_type ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆoperation / systemï¼‰

fields @timestamp, @message, json(@message, 'extra.log_type') as log_type
| filter log_type = "operation"
| sort @timestamp desc
| limit 50


â¸»

ğŸ” request_id ã§è¿½è·¡

fields @timestamp, json(@message, 'extra.request_id') as request_id, @message
| filter request_id = "abc-123"
| sort @timestamp asc


â¸»

ğŸ” user_id ã‚’æŠ½å‡ºã—ã¦ä¸€è¦§è¡¨ç¤º

fields @timestamp, json(@message, 'context.user_id') as user_id, @message
| filter user_id != ""
| sort @timestamp desc


â¸»

âœ… æœ€çµ‚ã¾ã¨ã‚

å¯¾å¿œé …ç›®	çŠ¶æ³
Laravelãƒãƒ¼ã‚¸ãƒ§ãƒ³	âœ… Laravel 12
ãƒ­ã‚°å½¢å¼	âœ… JSON
ãƒ­ã‚°å‡ºåŠ›å…ˆ	âœ… stdout / stderrï¼ˆCloudWatchãŒè‡ªå‹•åé›†ï¼‰
request_id	âœ… ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ç™ºè¡Œã€extraã«è¿½åŠ 
log_type	âœ… Processorã§è‡ªå‹•åˆ¤åˆ¥ã—ã€extraã«è¿½åŠ 
CloudWatchå¯¾å¿œ	âœ… json() é–¢æ•°ã§ãƒã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå¯èƒ½
ãƒ­ã‚°ã‚¯ã‚¨ãƒª	âœ… Logs Insights ã§ log_type / request_id ã«ã‚ˆã‚‹æ¤œç´¢å¯èƒ½


â¸»

å¿…è¦ã§ã‚ã‚Œã°ã€ã•ã‚‰ã« user_id / ip_address / route ãªã©ã‚‚ä»˜åŠ ã§ãã¾ã™ã®ã§ã€ã”ç›¸è«‡ãã ã•ã„ï¼